version: "3"
services:
  ydb:
    image: cr.yandex/yc/yandex-docker-local-ydb:trunk
    environment:
      - "YDB_DEFAULT_LOG_LEVEL=DEBUG"
      - "GRPC_TLS_PORT=2135"
      - "GRPC_PORT=2136"
      - "MON_PORT=8765"
      - "YDB_USE_IN_MEMORY_PDISKS=true"
      - "POSTGRES_PASSWORD=password"
    healthcheck:
      test: "/bin/sh /health_check"
      interval: 1s
      start_period: 10s
  ydb-reset-password:
    depends_on:
      ydb:
        condition: service_healthy
    image: cr.yandex/yc/yandex-docker-local-ydb:trunk
    command: /ydb -e grpc://ydb:2136 -d /local scripting yql -s "ALTER USER root PASSWORD NULL"
  go-libpq:
    depends_on:
      ydb-reset-password:
        condition: service_completed_successfully
    image: ydb-test/go-pqlib
    build:
      context: .
    environment:
      - PGUSER=root
      - PGHOST=ydb
      - PGPORT=5432
      - PQGOSSLTESTS=0
      - PQSSLCERTTEST_PATH=certs
    volumes:
      - ./project-sources:/sources
      - ../../../tmp/test-result/go-libpq:/test-result
